<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>今日の行き先リスト</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #fff; color: #000; }
    .next { font-size: 2em; font-weight: bold; margin-bottom: 1em; }
    .place { border: 1px solid #000; padding: 0.5em; margin-bottom: 0.5em; cursor: pointer; position: relative; }
    .todos { display: none; padding-left: 1em; }
    .edit-controls { display: none; position: absolute; right: 0.5em; top: 0.5em; }
    .edit-mode .edit-controls { display: block; }
    .edit-mode .place { cursor: default; }
    .hidden-in-list { display: none; }
    button { margin: 0 0.2em; }
    .control-panel {
      position: fixed;
      bottom: 1em;
      right: 1em;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
  </style>
</head>
<body>
  <div class="next" id="nextDisplay">Next: </div>
  <button onclick="toggleEdit()">編集</button>
  <div class="control-panel">
    <button onclick="toggleDataPanel()">データ</button>
  </div>
  <div id="places"></div>

  <div id="dataPanel" style="display:none; margin-top:2em;">
    <h3>データの読み込み／保存</h3>
    <textarea id="jsonInput" placeholder='[{"name":"場所","todos":["やること"],"hidden":false}]'></textarea><br>
    <button onclick="importData()">読み込み</button>
    <button onclick="exportData()">エクスポート</button>
  </div>

  <script>
    let editing = false;
    let data = [];

    function saveToStorage() {
      localStorage.setItem('destinationList', JSON.stringify(data));
    }

    function loadFromStorage() {
      const saved = localStorage.getItem('destinationList');
      if (saved) data = JSON.parse(saved);
      else data = [
        { name: "ららぽーと", todos: ["チャージ", "スリーブ購入"], hidden: false },
        { name: "平針", todos: ["ジムバ"], hidden: false },
        { name: "床屋", todos: ["散髪"], hidden: false },
        { name: "三洋堂", todos: ["e-hon", "フリューくじ"], hidden: false }
      ];
    }

    function render() {
      const placesDiv = document.getElementById("places");
      placesDiv.innerHTML = "";

      const visible = data.filter(d => !d.hidden);
      document.getElementById("nextDisplay").textContent = visible.length ? `Next: ${visible[0].name}` : "Next: -";

      data.forEach((place, index) => {
        const div = document.createElement("div");
        div.className = "place";
        if (!editing && place.hidden) div.classList.add("hidden-in-list");

        const label = document.createElement("span");
        label.textContent = place.name;

        const todos = document.createElement("div");
        todos.className = "todos";
        place.todos.forEach(t => {
          const item = document.createElement("div");
          item.textContent = `・${t}`;
          todos.appendChild(item);
        });

        div.appendChild(label);
        div.appendChild(todos);

        if (!editing) {
          div.onclick = () => {
            todos.style.display = todos.style.display === "none" ? "block" : "none";
          };
        } else {
          const controls = document.createElement("span");
          controls.className = "edit-controls";

          const check = document.createElement("input");
          check.type = "checkbox";
          check.checked = !place.hidden;
          check.onchange = () => {
            place.hidden = !check.checked;
            saveToStorage();
            render();
          };

          const up = document.createElement("button");
          up.textContent = "↑";
          up.onclick = () => {
            if (index > 0) {
              [data[index - 1], data[index]] = [data[index], data[index - 1]];
              saveToStorage();
              render();
            }
          };

          const down = document.createElement("button");
          down.textContent = "↓";
          down.onclick = () => {
            if (index < data.length - 1) {
              [data[index + 1], data[index]] = [data[index], data[index + 1]];
              saveToStorage();
              render();
            }
          };

          controls.appendChild(check);
          controls.appendChild(up);
          controls.appendChild(down);
          div.appendChild(controls);
        }

        placesDiv.appendChild(div);
      });

      saveToStorage();
    }

    function toggleEdit() {
      editing = !editing;
      document.body.classList.toggle("edit-mode", editing);
      render();
    }

    function toggleDataPanel() {
      const panel = document.getElementById("dataPanel");
      panel.style.display = panel.style.display === "none" ? "block" : "none";
    }

    function importData() {
      try {
        const input = document.getElementById("jsonInput").value;
        const parsed = JSON.parse(input);
        if (Array.isArray(parsed)) {
          data = parsed;
          saveToStorage();
          render();
        } else {
          alert("配列形式のJSONを入力してください");
        }
      } catch (e) {
        alert("JSONの形式に誤りがあります");
      }
    }

    function exportData() {
      const json = JSON.stringify(data, null, 2);
      const input = document.getElementById("jsonInput");
      input.value = json;
      navigator.clipboard.writeText(json).then(() => alert("クリップボードにコピーしました"));
    }

    loadFromStorage();
    render();
  </script>
</body>
</html>
